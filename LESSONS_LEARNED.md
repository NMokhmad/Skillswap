# Le√ßons tir√©es du projet Skillswap

## Table des mati√®res

1. [SQL et Base de donn√©es](#1-sql-et-base-de-donn√©es)
2. [Migrations](#2-migrations)
3. [S√©curit√©](#3-s√©curit√©)
4. [Tests](#4-tests)
5. [Architecture et bonnes pratiques](#5-architecture-et-bonnes-pratiques)
6. [Ce qui est bien fait](#6-ce-qui-est-bien-fait)
7. [Ce qui doit √™tre am√©lior√©](#7-ce-qui-doit-√™tre-am√©lior√©)
8. [Suivi des corrections](#8-suivi-des-corrections)
9. [Mise √† jour Phase 2/3](#9-mise-√†-jour-phase-23)
10. [Mise √† jour Fiabilit√©/Qualit√©](#10-mise-√†-jour-fiabilit√©qualit√©)

---

## 1. SQL et Base de donn√©es

### Ce que tu as bien fait

- **`BEGIN` / `COMMIT`** dans `create_db.sql` : encapsuler la cr√©ation de tables dans une transaction garantit que soit tout est cr√©√©, soit rien ne l'est. Si une erreur survient √† la table 5, les 4 premi√®res ne resteront pas orphelines.

- **`GENERATED BY DEFAULT AS IDENTITY`** au lieu de `SERIAL` : c'est la syntaxe moderne SQL standard (PostgreSQL 10+). `SERIAL` est un raccourci PostgreSQL sp√©cifique, `IDENTITY` est conforme au standard SQL.

- **Contraintes `UNIQUE` composites** : `UNIQUE("reviewer_id", "reviewed_id", "skill_id")` sur `review` et `UNIQUE("follower_id", "followed_id")` sur `user_has_follow` emp√™chent les doublons au niveau de la base, pas juste au niveau de l'application. C'est la bonne approche.

- **`TIMESTAMPTZ`** au lieu de `TIMESTAMP` : stocker le fuseau horaire est essentiel pour une application qui pourrait avoir des utilisateurs dans diff√©rents fuseaux.

- **Cl√©s √©trang√®res d√©clar√©es inline** : `"role_id" INT NOT NULL REFERENCES "role"("id") DEFAULT 1` est clair et lisible.

- ‚úÖ **`CHECK` constraint sur `rate`** : `CHECK (rate >= 1 AND rate <= 5)` emp√™che les donn√©es invalides au niveau de la base, m√™me si quelqu'un contourne l'API. Bien corrig√©.

- ‚úÖ **`ON DELETE CASCADE`** sur toutes les FK : quand un utilisateur est supprim√©, toutes ses reviews, messages, follows, etc. sont automatiquement supprim√©s. Plus besoin de 6 requ√™tes manuelles.

- ‚úÖ **`DEFAULT false` pour `is_read`** dans `message` et **`DEFAULT` pour `is_available`** dans `user` : les valeurs par d√©faut emp√™chent les NULL inattendus.

### Ce qui peut encore √™tre am√©lior√©

- **Pas d'index explicites** : les colonnes fr√©quemment recherch√©es devraient avoir des index. Les colonnes `UNIQUE` cr√©ent automatiquement un index, mais les FK simples (comme `reviewed_id`, `sender_id`) n'en ont pas automatiquement :
  ```sql
  CREATE INDEX idx_review_reviewed_id ON review(reviewed_id);
  CREATE INDEX idx_review_reviewer_id ON review(reviewer_id);
  CREATE INDEX idx_message_sender_id ON message(sender_id);
  CREATE INDEX idx_message_receiver_id ON message(receiver_id);
  CREATE INDEX idx_notification_user_id ON notification(user_id);
  ```
  **Pourquoi c'est important** : sans index, chaque recherche par FK fait un "sequential scan" (lecture de TOUTE la table). Avec 10 000 messages, chercher les messages d'un utilisateur prend 100x plus de temps sans index.

- **`DROP TABLE IF EXISTS` au d√©but** : c'est pratique pour le d√©veloppement mais dangereux si ce script √©tait ex√©cut√© en production. En production, on utilise des migrations (pas des scripts de recr√©ation).

- **Donn√©es de seed invalides** : `seeding_tables.sql` ligne 38 ins√®re un `rate=0` qui viole la contrainte `CHECK (rate >= 1 AND rate <= 5)`. Le seed √©chouera. Il faut corriger cette valeur.

---

## 2. Migrations

### Le√ßon principale : `sequelize.sync()` n'est PAS une migration

Dans `index.js`, l'application tourne maintenant en `sequelize.sync()` (sans `alter`) en dev et en prod. C'est plus s√ªr que `alter`, mais √ßa reste insuffisant pour un vrai pilotage de sch√©ma. Voici pourquoi :

| | `sync({ alter: true })` | Vraies migrations |
|---|---|---|
| **Quoi** | Compare les mod√®les JS aux tables et modifie la DB | Scripts SQL versionn√©s ex√©cut√©s un par un |
| **Reproductible** | Non, d√©pend de l'√©tat actuel | Oui, chaque migration a un `up` et un `down` |
| **Perte de donn√©es** | Possible (renommer une colonne = supprimer + cr√©er) | Contr√¥l√© (tu √©cris le ALTER toi-m√™me) |
| **Historique** | Aucun | Chaque changement est trac√© et versionn√© |
| **Production** | JAMAIS | Oui, c'est fait pour √ßa |
| **Rollback** | Impossible | `migrate:undo` |

### Comment √ßa devrait fonctionner

1. **Cr√©er une migration** pour chaque changement de sch√©ma :
   ```bash
   npx sequelize-cli migration:generate --name add-avatar-to-user
   ```

2. **√âcrire le `up` et le `down`** :
   ```javascript
   // up: ce que fait la migration
   await queryInterface.addColumn('user', 'avatar_url', { type: Sequelize.TEXT });

   // down: comment annuler la migration
   await queryInterface.removeColumn('user', 'avatar_url');
   ```

3. **Ex√©cuter** : `npx sequelize-cli db:migrate`

4. **Rollback si probl√®me** : `npx sequelize-cli db:migrate:undo`

### R√®gle d'or

> En d√©veloppement : √©viter `sync({ alter: true })` sur une base partag√©e.
> En staging/production : UNIQUEMENT des migrations versionn√©es.
> Ne JAMAIS utiliser `sync({ force: true })` sauf sur une base jetable.

**√âtat actuel** : les migrations SQL existent (`migration_v2.sql`, `migration_v3.sql`) et doivent √™tre ex√©cut√©es sur toute base d√©j√† existante.

---

## 3. S√©curit√©

### Ce qui est bien fait (et pourquoi)

- **Argon2 pour le hachage** : c'est le meilleur choix actuel (vainqueur du Password Hashing Competition 2015). Il est r√©sistant aux attaques GPU contrairement √† bcrypt. Bien jou√©.

- **JWT dans un cookie `httpOnly`** : un cookie `httpOnly` ne peut pas √™tre lu par JavaScript c√¥t√© client. √áa prot√®ge contre le vol de token via XSS. C'est mieux que de stocker le JWT dans `localStorage`.

- **`sameSite: 'Strict'`** : emp√™che l'envoi du cookie lors de requ√™tes cross-origin. Protection contre les attaques CSRF.

- **Protection contre le mass assignment** : dans `profilController.updateProfile`, seuls `firstname`, `lastname`, `email` sont extraits du `req.body` via d√©structuration. M√™me si un attaquant envoie `role_id: 1` dans le body, √ßa sera ignor√©.

- **Double strat√©gie JWT** (`verifyJWT` / `optionalJWT`) : bonne s√©paration entre les routes qui n√©cessitent absolument une authentification et celles qui s'adaptent. Le comportement diff√©rent GET vs POST/PUT/DELETE est bien pens√©.

- ‚úÖ **Helmet CSP correctement configur√©** : les directives CSP sont maintenant bien d√©finies avec les sources externes autoris√©es (FontAwesome, Google Fonts, etc.). C'est une des protections les plus importantes contre XSS.

- ‚úÖ **Sanitisation HTML globale** : le middleware `sanitizeHtml.js` nettoie r√©cursivement `req.body` et `req.query` en supprimant tous les tags HTML. Excellente protection contre le XSS stock√©.

- ‚úÖ **Auth rate limiting am√©lior√©** : pass√© de 100 000 √† 15 tentatives par 15 minutes. C'est raisonnable.

### Ce qui doit √™tre corrig√©

#### [CORRIG√â] Rate limiting global

```javascript
// index.js
const globalLimiter = rateLimit({
  windowMs: 60 * 1000,
  max: 100,
});
```

Statut : corrig√©.

#### [CORRIG√â] Cookie `userInfo` non `httpOnly`

```javascript
// Plus de cookie userInfo non-httpOnly
// Les vues re√ßoivent l'utilisateur via res.locals.user (middleware userInfoCookie.js)
```

Statut : corrig√©.

#### [CORRIG√â] Logout en GET

```javascript
// router.js
router.post('/logout', authController.logout);
```

Statut : corrig√© (route POST + formulaires).

#### [CORRIG√â] Mot de passe minimum

Le minimum est maintenant √† 8 caract√®res. Statut : corrig√©.

#### [IMPORTANT] SSL `rejectUnauthorized: false`

```javascript
// database.js
dialectOptions: { ssl: { require: true, rejectUnauthorized: false } }
```

√áa d√©sactive la v√©rification du certificat SSL. Un attaquant qui intercepte la connexion entre l'app et la base de donn√©es (attaque Man-in-the-Middle) ne sera pas d√©tect√©. En production, utiliser `rejectUnauthorized: true` avec le certificat CA du fournisseur.

#### [MINEUR] Timing attack possible au login

```javascript
// authController.js
const user = await User.findOne({ where: { email } });
if (!user) { return res.status(401)... }
const isValid = await argon2.verify(user.password, password);
```

Le temps de r√©ponse diff√®re entre "utilisateur inexistant" (rapide) et "mauvais mot de passe" (lent, car argon2 prend du temps). Un attaquant peut en d√©duire quels emails existent dans la base. Solution : toujours ex√©cuter `argon2.verify()` m√™me si l'utilisateur n'existe pas (avec un hash factice).

---

## 4. Tests

### Ce qui est bien fait

- **Tests cibl√©s sur la s√©curit√©** : les 3 fichiers de tests couvrent les aspects critiques (JWT, autorisation, validation). C'est le bon r√©flexe : tester en priorit√© ce qui prot√®ge l'application.

- **Mocking propre** : les fonctions `mockReq()` et `mockRes()` sont bien con√ßues, r√©utilisables, et simulent fid√®lement le comportement d'Express.

- **Tests des cas limites** : token expir√©, token sign√© avec un mauvais secret, pr√©nom trop court, pr√©nom trop long, email invalide... Les cas limites sont bien couverts.

- **`abortEarly: false`** : tester que Joi retourne TOUTES les erreurs d'un coup (pas juste la premi√®re) est important pour l'UX.

- ‚úÖ **Tests d'autorisation appellent les vrais controllers** : `authorization.test.js` appelle maintenant `profilController.updateProfile`, `profilController.deleteProfile`, `authController.logout`. Plus de logique dupliqu√©e dans les tests. Excellent.

### Ce qui peut √™tre am√©lior√©

#### Pas de tests d'int√©gration

Les tests actuels sont tous des tests unitaires qui ne touchent jamais la base de donn√©es. Il manque des tests qui v√©rifient le cycle complet :
```javascript
// Exemple de test d'int√©gration
test('un utilisateur peut cr√©er un avis', async () => {
  // 1. Cr√©er un utilisateur en base
  // 2. Cr√©er un skill en base
  // 3. Appeler POST /review/:userId
  // 4. V√©rifier que l'avis est bien en base
  // 5. Nettoyer la base
});
```

Pour √ßa, il faut :
- Une base de donn√©es de test s√©par√©e (`skillswap_test`)
- Un setup/teardown qui nettoie entre chaque test
- Supertest pour tester les routes HTTP

#### Couverture insuffisante

Ce qui n'est **pas** test√© :
- `messageController` (envoi, lecture, conversations)
- `followController` (follow/unfollow)
- `reviewController` (cr√©ation d'avis)
- `mainController` (homepage, recherche, onboarding)
- `profilController.deleteProfile` (suppression en cascade)
- Les mod√®les Sequelize et leurs associations
- Les cas d'erreur serveur (que se passe-t-il si la DB est down ?)

#### Structure AAA

Les tests pourraient utiliser le pattern AAA (Arrange, Act, Assert) de mani√®re plus explicite :
```javascript
test('description', () => {
  // Arrange - pr√©parer les donn√©es
  const req = mockReq({...});
  const res = mockRes();

  // Act - ex√©cuter l'action
  verifyJWT(req, res, next);

  // Assert - v√©rifier le r√©sultat
  expect(res.redirectUrl).toBe('/login');
});
```

---

## 5. Architecture et bonnes pratiques

### Ce qui est bien fait

- **S√©paration des responsabilit√©s** : models / controllers / middlewares / schemas / views ‚Äî chaque couche a son r√¥le clair.

- **Router centralis√©** avec sections comment√©es (routes publiques vs prot√©g√©es) : on voit d'un coup d'oeil quelle route n√©cessite quelle authentification.

- **`router.route()` pour grouper les m√©thodes HTTP** :
  ```javascript
  router.route("/user/:id/profil")
    .get(verifyJWT, mainController.renderProfilePage)
    .post(verifyJWT, profilController.updateProfile)
    .delete(verifyJWT, profilController.deleteProfile);
  ```
  C'est plus propre que 3 lignes s√©par√©es.

- **Associations Sequelize bidirectionnelles** : `User.hasMany(Review)` ET `Review.belongsTo(User)` sont toujours d√©clar√©es ensemble. Le fichier `models/index.js` est exemplaire.

- **Helpers r√©utilisables** : `addAverageRating()` √©vite la duplication du calcul de moyenne dans chaque controller.

- **S√©paration dev/prod** dans `index.js` : `sync()` sans `alter` et migrations SQL explicites (`migration_v2.sql`, `migration_v3.sql`). Cette approche √©vite les surprises de sch√©ma en base existante.

- **Middleware sanitizeHtml** : r√©cursif, global, et bien plac√© dans la cha√Æne de middlewares (avant le router).

### Ce qui doit √™tre am√©lior√©

#### [CRITIQUE] Pas de pagination

Les routes `/talents` et `/skills` chargent TOUS les utilisateurs/skills d'un coup. Avec 10 utilisateurs c'est OK, avec 10 000 √ßa crashera par √©puisement m√©moire. Il faut :
```javascript
const page = parseInt(req.query.page) || 1;
const limit = 20;
const offset = (page - 1) * limit;
const users = await User.findAndCountAll({ limit, offset });
```

**Concept √† apprendre** : pagination offset-based vs cursor-based. L'offset est simple mais a des probl√®mes de performance avec de tr√®s gros offsets. Le cursor utilise un point de rep√®re (ex: `WHERE id > lastId LIMIT 20`) et est plus performant.

#### [CORRIG√â] N+1 query dans la recherche

La recherche avanc√©e a √©t√© d√©plac√©e dans `searchController` avec construction SQL dynamique (`where/include/group/having/order`) et endpoints d√©di√©s. Le pattern N+1 initial de `mainController.searchPage` n'est plus le chemin principal.

#### Incoh√©rence de nommage

```javascript
// M√©lange fran√ßais/anglais
renderloginPage    // ‚Üê 'l' minuscule, devrait √™tre renderLoginPage
renderRegisterPage // ‚Üê correct
profilController   // ‚Üê fran√ßais
reviewController   // ‚Üê anglais
```

**R√®gle** : choisir UNE langue (de pr√©f√©rence l'anglais pour le code) et UN style de nommage, puis s'y tenir partout.

#### Code dupliqu√© pour les cookies

La logique de cr√©ation de cookie JWT est identique dans `register` et `login` :
```javascript
// R√©p√©t√© 2 fois dans authController.js
res.cookie('token', token, { httpOnly: true, secure: ..., sameSite: 'Strict' });
res.cookie('userInfo', JSON.stringify({...}), { httpOnly: false, secure: ..., sameSite: 'Strict' });
```

√áa devrait √™tre un helper :
```javascript
function setAuthCookies(res, user, token) {
  res.cookie('token', token, { httpOnly: true, secure: ..., sameSite: 'Strict' });
  // Id√©alement, supprimer le cookie userInfo et utiliser res.locals
}
```

#### Gestionnaire d'erreurs trop g√©n√©rique

```javascript
app.use((err, req, res, next) => {
  console.error(err.stack);
  res.status(500).render('404', { title: 'Erreur serveur', cssFile: '404' });
});
```

Probl√®mes :
- Affiche la page 404 pour une erreur 500 (confusing pour l'utilisateur)
- En d√©veloppement, on veut voir le d√©tail de l'erreur
- Pas de distinction entre les types d'erreurs

Solution : cr√©er une vue `500.ejs` d√©di√©e et afficher le stack en dev :
```javascript
app.use((err, req, res, next) => {
  console.error(err.stack);
  const status = err.status || 500;
  res.status(status).render('error', {
    title: 'Erreur serveur',
    cssFile: 'error',
    message: process.env.NODE_ENV === 'development' ? err.message : 'Une erreur est survenue',
  });
});
```

#### [CORRIG√â] Mod√®le Notification d√©sormais actif

Le mod√®le `Notification.js` est maintenant utilis√© par `notificationController` et `notificationHelper` (cr√©ation, marquage lu, suppression, √©mission temps r√©el Socket.IO).

#### `method-override` pour DELETE

L'utilisation de `method-override` avec `?_method=DELETE` dans les formulaires HTML est une solution acceptable pour les formulaires classiques (HTML ne supporte que GET/POST), mais il faut savoir que c'est un pattern legacy. Pour une API moderne, on utiliserait `fetch` avec la m√©thode DELETE directement.

---

## 6. Ce qui est bien fait (r√©sum√©)

| Aspect | D√©tail | Statut |
|--------|--------|--------|
| Hachage mot de passe | Argon2 (meilleur choix actuel) | ‚≠ê Excellent |
| Authentification | JWT dans cookie httpOnly + sameSite Strict | üü¢ Bon |
| Validation | Joi avec schemas d√©di√©s par action | üü¢ Bon |
| Mass assignment | Whitelist par d√©structuration | ‚≠ê Excellent |
| Architecture | MVC clair avec s√©paration des couches | üü¢ Bon |
| Associations Sequelize | Bidirectionnelles, bien nomm√©es avec alias | ‚≠ê Excellent |
| SQL | Transactions, IDENTITY, TIMESTAMPTZ, CHECK, CASCADE | üü¢ Bon |
| Tests | Focalis√©s sur la s√©curit√©, appellent les vrais controllers | üü¢ Bon |
| Middleware JWT | Double strat√©gie (strict / optionnel) | ‚≠ê Excellent |
| CSP Helmet | Correctement configur√© avec whitelist | üü¢ Bon |
| Sanitisation HTML | Middleware global r√©cursif | üü¢ Bon |
| S√©paration dev/prod | sync, trust proxy, rate limiting adapt√©s | üü¢ Bon |

---

## 7. Ce qui doit √™tre am√©lior√© (r√©sum√© prioris√©)

### Priorit√© haute [CRITIQUE]

| # | Probl√®me | Impact | Solution | Statut |
|---|----------|--------|----------|--------|
| 1 | Rate limit global = 1000 | Scraping/brute force possible | Mettre `max: 100` | ‚úÖ Corrig√© |
| 2 | Cookie `userInfo` non httpOnly | Donn√©es user lisibles via XSS | Passer les infos via `res.locals` uniquement | ‚úÖ Corrig√© |
| 3 | Pas de pagination | Crash m√©moire √† l'√©chelle | `findAndCountAll` avec `limit`/`offset` | ‚úÖ Corrig√© (/talents) |

### Priorit√© moyenne [IMPORTANT]

| # | Probl√®me | Impact | Solution | Statut |
|---|----------|--------|----------|--------|
| 4 | Logout en GET | CSRF via `<img src="/logout">` | Passer en POST + verifyJWT | ‚úÖ Corrig√© |
| 5 | Mot de passe min 6 chars | Brute force offline r√©aliste | Augmenter √† 8 minimum | ‚úÖ Corrig√© |
| 6 | SSL rejectUnauthorized: false | Vuln√©rable au MITM | Utiliser le certificat CA du provider | ‚ùå √Ä corriger |
| 7 | Pas d'index sur les FK | Requ√™tes lentes sur les jointures | `CREATE INDEX` sur les FK fr√©quentes | ‚úÖ Corrig√© |
| 8 | N+1 query dans la recherche | Performance d√©grad√©e | Utiliser `include` dans la requ√™te initiale | ‚úÖ Corrig√© |
| 9 | Pas de tests d'int√©gration | Pas de garantie bout en bout | Supertest + base de test | ‚ùå √Ä corriger |
| 10 | Erreur 500 affiche page 404 | UX confusante | Cr√©er une vraie page erreur 500 | ‚úÖ Corrig√© |

### Priorit√© basse [MINEUR]

| # | Probl√®me | Impact | Solution | Statut |
|---|----------|--------|----------|--------|
| 11 | Nommage incoh√©rent (fr/en) | Lisibilit√© du code | Choisir une langue et s'y tenir | ‚ùå √Ä corriger |
| 12 | Code cookie dupliqu√© | Maintenance plus difficile | Extraire un helper `setAuthCookies` | ‚ùå √Ä corriger |
| 13 | `sync({ alter: true })` en dev | Mauvaise habitude | Utiliser les migrations m√™me en dev | ‚úÖ Corrig√© |
| 14 | Timing attack au login | Fuite d'emails existants | Toujours ex√©cuter argon2.verify | ‚úÖ Corrig√© |
| 15 | Seed data invalide (rate=0) | Seed √©choue | Corriger √† rate >= 1 | ‚úÖ Corrig√© |
| 16 | Notification model inutilis√© | Code mort | Impl√©menter ou supprimer | ‚úÖ Corrig√© |

---

## 8. Suivi des corrections

### Corrections effectu√©es depuis la premi√®re revue ‚úÖ

| Probl√®me original | Correction | Date |
|---|---|---|
| CSP Helmet d√©sactiv√© | Directives CSP correctement configur√©es | F√©vrier 2025 |
| Rate limit auth = 100 000 | R√©duit √† 15 tentatives/15 min | F√©vrier 2025 |
| Pas de CHECK sur rate | `CHECK (rate >= 1 AND rate <= 5)` + validation Sequelize | F√©vrier 2025 |
| Pas de ON DELETE CASCADE | CASCADE sur toutes les FK | F√©vrier 2025 |
| Tests testaient une copie du code | Tests appellent les vrais controllers | F√©vrier 2025 |
| Pas de sanitisation HTML | Middleware sanitizeHtml global et r√©cursif | F√©vrier 2025 |
| Pas de DEFAULT is_read/is_available | DEFAULT ajout√©s dans le SQL | F√©vrier 2025 |

### Corrections effectu√©es lors de la deuxi√®me revue ‚úÖ

| Probl√®me | Correction | Date |
|---|---|---|
| Rate limit global = 1000 | R√©duit √† 100 requ√™tes/min | F√©vrier 2026 |
| Cookie `userInfo` non httpOnly | Supprim√© ‚Äî `userInfoCookie.js` d√©code le JWT directement | F√©vrier 2026 |
| Pas de pagination | `findAndCountAll` avec limit/offset sur /talents (12/page) | F√©vrier 2026 |
| Pas d'index sur les FK | 5 index ajout√©s dans `create_db.sql` | F√©vrier 2026 |
| Mot de passe min 6 caract√®res | Augment√© √† 8 dans les sch√©mas Joi | F√©vrier 2026 |
| Erreur 500 affiche page 404 | Page `500.ejs` d√©di√©e cr√©√©e | F√©vrier 2026 |
| Seed data invalide (rate=0) | Corrig√© √† rate=3 | F√©vrier 2026 |
| Dossier uploads manquant en prod | Cr√©ation automatique dans `upload.js` | F√©vrier 2026 |
| Stats hardcod√©es dans skills.ejs | Dynamis√©es depuis la base de donn√©es | F√©vrier 2026 |
| Recherche skills non branch√©e | Filtrage c√¥t√© client impl√©ment√© | F√©vrier 2026 |

### Progression globale

- **Premi√®re revue** : 15 probl√®mes identifi√©s
- **Corrig√©s en premi√®re passe** : 7/15 (47%)
- **Nouveaux probl√®mes d√©couverts** : 5 (timing attack, SSL, logout GET, seed invalide, N+1 query)
- **Corrig√©s en deuxi√®me passe** : 10 probl√®mes suppl√©mentaires
- **Corrig√©s en troisi√®me passe (phase 2/3)** : logout POST, recherche avanc√©e, notifications actives, abandon de `sync({ alter: true })`
- **Total restant** : 5 probl√®mes (0 critique, 2 importants, 3 mineurs)

---

## Conclusion

Ce projet a atteint un **bon niveau de qualit√©** apr√®s trois passes de correction. Les fonctionnalit√©s phase 2/3 sont en place (Socket.IO messagerie, notifications, recherche avanc√©e, recherches sauvegard√©es) et les principaux points de robustesse ont √©t√© trait√©s.

Les axes d'am√©lioration restants sont :

1. **SSL `rejectUnauthorized: true`** en production
2. **Tests d'int√©gration DB r√©elle** (la suite HTTP est en place, mais sans base d√©di√©e)
3. **Nommage coh√©rent** (choisir une langue)
4. **Code cookie JWT dupliqu√©** (factoriser un helper)
5. **Durcir la couverture E2E Socket.IO** (actuellement valid√© surtout en manuel)

**Note de qualit√© globale : üü¢ Bon**

La v2 (messagerie WebSocket, notifications, recherche avanc√©e) est d√©sormais impl√©ment√©e.

---

## 9. Mise √† jour Phase 2/3

### Fonctionnalit√©s livr√©es

- Notifications compl√®tes : badge, dropdown, page `/notifications`, API read/delete/count/recent.
- Temps r√©el Socket.IO : notifications live + chat live (`message:send`, `message:typing`, `message:read`).
- Messagerie : `read_at`, unread count API, UI conversation dynamique via `public/js/chat.js`.
- Recherche avanc√©e : `searchController`, filtres combin√©s, autocomplete, pagination, tri `popular`.
- Recherches sauvegard√©es : mod√®le `SavedSearch` + API save/list/delete.

### Le√ßons op√©rationnelles importantes

- Une base existante doit recevoir les migrations SQL (`migration_v2.sql`, `migration_v3.sql`) avant d'utiliser les nouveaux mod√®les.
- `sequelize.sync({ alter: true })` peut casser en pr√©sence de donn√©es existantes (cas r√©el: `role.updated_at` NULL) ; √©viter cette strat√©gie sur environnement partag√©.
- Documenter explicitement l'ordre d'upgrade DB √©vite les erreurs runtime du type "colonne inexistante".

---

## 10. Mise √† jour Fiabilit√©/Qualit√©

### Contexte et objectif

Le plan "Fiabilit√©/Qualit√© orient√©e d√©mo" a √©t√© ex√©cut√© pour am√©liorer la cr√©dibilit√© technique du projet:

- rendre les erreurs API lisibles et tra√ßables;
- √©viter les r√©gressions sur les parcours critiques;
- disposer d'une d√©monstration reproductible;
- poser une base r√©aliste pour un environnement de production.

Ce n'est pas une refonte d'architecture. L'objectif √©tait d'augmenter la **qualit√© op√©rationnelle** sans casser les fonctionnalit√©s existantes (messagerie, notifications, recherche).

### 10.1 Architecture runtime: s√©paration app/serveur

Refactor principal:

- `app/createApp.js` construit l'application Express (middlewares, router, erreurs).
- `index.js` orchestre le runtime (HTTP server, Socket.IO, auth socket, boot).

Pourquoi c'est mieux:

- meilleure testabilit√© (on peut instancier l'app sans d√©marrer le serveur r√©seau);
- responsabilit√©s plus claires;
- r√©duction des effets de bord au d√©marrage.

Le√ßon:

> La s√©paration "construction d'app" vs "process de d√©marrage" est un gain rapide en maintenabilit√©, m√™me sur un projet junior.

### 10.2 Contrat d'erreurs API et corr√©lation des requ√™tes

Standardisation mise en place:

- format unique: `error.code`, `error.message`, `error.requestId`;
- helper central: `app/helpers/apiResponse.js`;
- middleware `requestId` qui:
  - reprend `X-Request-Id` si fourni;
  - sinon g√©n√®re un UUID;
  - renvoie toujours ce header en r√©ponse.

Routes sant√© ajout√©es:

- `GET /healthz` (liveness);
- `GET /readyz` (readiness + check DB).

B√©n√©fice direct:

- un front peut parser les erreurs de mani√®re d√©terministe;
- un log backend peut √™tre corr√©l√© √† un bug utilisateur gr√¢ce au `requestId`;
- monitoring simplifi√© (health checks clairs).

### 10.3 Observabilit√© pragmatique

Ce qui a √©t√© int√©gr√©:

- logger JSON (`app/helpers/logger.js`);
- log de chaque requ√™te (`requestId`, route, status, dur√©e, userId si pr√©sent);
- capture Sentry optionnelle (`app/helpers/sentry.js`) avec fallback safe.

D√©cision importante:

- Sentry est "best effort": si le package n'est pas install√©, l'app continue.

Pourquoi ce choix:

- √©viter de bloquer le d√©veloppement local;
- permettre l'activation progressive en staging/prod.

### 10.4 S√©curit√©: correctifs √† fort rendement

1. **Timing attack login**
- avant: chemin rapide si email absent;
- apr√®s: v√©rification Argon2 toujours ex√©cut√©e via hash factice.
- impact: pas de leak √©vident sur l'existence d'un compte.

2. **SSL base de donn√©es**
- ajout de `ENABLE_STRICT_DB_SSL` + `DATABASE_SSL_CA`;
- mode strict possible (`rejectUnauthorized: true`) sans modifier le code.

3. **Validation Socket.IO**
- validations d√©di√©es pour `message:send`, `message:typing`, `message:read`;
- normalisation des erreurs m√©tier envoy√©es au client (`message:error`).

4. **Sync Sequelize**
- `sequelize.sync()` n'est plus ex√©cut√© automatiquement au d√©marrage;
- activation explicite via `ENABLE_SEQUELIZE_SYNC=true`.

Le√ßon:

> Les gains s√©curit√© les plus utiles en portfolio ne sont pas "th√©oriques"; ce sont des points visibles en revue de code et en incident r√©el.

### 10.5 Strat√©gie de tests: mont√©e en maturit√©

Nouveaux tests unitaires:

- `requestId` middleware;
- validation payload Socket.IO;
- mitigation timing attack sur login.

Mise √† jour des tests existants:

- alignement sur le nouveau contrat d'erreur API JSON.

Tests d'int√©gration ajout√©s (`tests_integration/`):

- contrat API;
- sant√© (`healthz`, `readyz`);
- sc√©narios m√©tiers notifications/messages/recherche/saved-search avec ownership.

R√©sultat actuel:

- unitaires: **51 tests**;
- int√©gration: **12 tests**;
- ex√©cution globale: `npm run test:all` vert.

Le√ßon importante:

- dans un environnement sandbox, les tests r√©seau "vrais" peuvent √©chouer (`listen EPERM`);
- fallback adopt√©: int√©gration contr√¥leur + middleware sans port r√©seau, mais couvrant le comportement m√©tier.

### 10.6 CI bloquante

Workflow ajout√©: `.github/workflows/ci.yml`

√âtapes:

1. `npm ci`
2. `npm run lint`
3. `npm test -- --runInBand`
4. `npm run test:integration`
5. `npm run ci:check:migrations`

Scripts qualit√© introduits:

- `npm run lint`
- `npm run test:all`
- `npm run ci:check`

B√©n√©fice:

- qualit√© v√©rifi√©e automatiquement sur PR;
- diminution du risque de merge cassant.

### 10.7 Packaging d√©mo et storytelling technique

Livrables:

- runbook: `docs/demo-runbook.md`;
- scripts:
  - `npm run demo:setup`
  - `npm run demo:reset`
  - `npm run demo:smoke`

Points couverts par le smoke:

- health endpoint;
- endpoint recherche public;
- endpoint prot√©g√© notifications si credentials fournis.

Le√ßon:

> Une d√©mo reproductible en 3 commandes vaut plus qu'une longue explication sur "ce qui marche chez moi".

### 10.8 Arbitrages et limites connues

Ce qui a volontairement √©t√© laiss√© hors scope:

- pas de migration vers SPA/microservices;
- pas d'OpenTelemetry complet;
- pas de tests E2E navigateur (Playwright/Cypress) pour ce lot.

Limites restantes:

1. SSL strict DB doit √™tre activ√© en environnement r√©el avec CA valide.
2. Couverture Socket.IO encore majoritairement validation + manuel, pas full E2E.
3. Nommage FR/EN encore mixte dans certains modules legacy.
4. Factorisation possible des cookies JWT (register/login).

### 10.9 Ce que ce lot prouve en entretien

Comp√©tences d√©montrables:

- savoir prioriser les risques (fiabilit√© > features "cosm√©tiques");
- transformer des probl√®mes flous en garde-fous concrets (tests + CI + runbook);
- am√©liorer la s√©curit√© sans bloquer la livraison;
- travailler incr√©mentalement avec un syst√®me existant.

Message recruteur:

> Le projet ne se contente plus de "fonctionner". Il est instrument√©, testable, et d√©montrable de mani√®re reproductible.
