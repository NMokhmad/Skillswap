<nav class="ss-nav">
    <div class="ss-nav-inner">

        <!-- ── Brand ── -->
        <div class="ss-nav-brand">
            <a href="/" class="ss-nav-logo">SkillSwap</a>

            <!-- Mobile : cloche + avatar (caché sur desktop via CSS) -->
            <% if (user) { %>
                <div class="ss-nav-mobile-right">
                    <div class="ss-notif-bell-wrap" id="notifBellMobile">
                        <a href="/notifications" class="ss-notif-btn">
                            <i class="fa-solid fa-bell"></i>
                            <span class="notif-badge" id="notifBadgeMobile" style="display:none;">0</span>
                        </a>
                    </div>

                    <div class="ss-avatar-wrap" id="userDropdownMobile">
                        <button class="ss-avatar-btn" id="userDropdownMobileToggle" aria-label="Menu utilisateur">
                            <i class="fas fa-user-circle"></i>
                        </button>
                        <div class="ss-dropdown ss-dropdown--left">
                            <a href="/user/<%= user.id %>/profil" class="ss-dropdown-item">
                                <i class="fas fa-user ss-di-amber"></i>
                                Mon profil
                            </a>
                            <a href="/messages" class="ss-dropdown-item">
                                <i class="fas fa-envelope ss-di-amber"></i>
                                Messages
                                <span class="message-badge" id="messageBadgeMobile" style="display:none;">0</span>
                            </a>
                            <a href="/notifications" class="ss-dropdown-item">
                                <i class="fas fa-bell ss-di-amber"></i>
                                Notifications
                            </a>
                            <hr class="ss-dropdown-sep">
                            <form action="/logout" method="POST" class="ss-dropdown-item ss-dropdown-item--logout">
                                <button type="submit">
                                    <i class="fas fa-sign-out-alt"></i>
                                    Déconnexion
                                </button>
                            </form>
                        </div>
                    </div>
                </div>
            <% } %>

            <!-- Burger -->
            <button class="ss-burger" id="burger" aria-label="Ouvrir le menu" aria-expanded="false">
                <span></span>
                <span></span>
                <span></span>
                <span></span>
            </button>
        </div>

        <!-- ── Menu ── -->
        <div class="ss-nav-menu" id="navbarMenu">
            <div class="ss-nav-links">
                <a href="/" class="ss-nav-link">
                    <i class="fas fa-home"></i>
                    <span>Accueil</span>
                </a>
                <a href="/talents" class="ss-nav-link">
                    <i class="fas fa-users"></i>
                    <span>Talents</span>
                </a>
                <a href="/skills" class="ss-nav-link">
                    <i class="fas fa-star"></i>
                    <span>Compétences</span>
                </a>
                <a href="/search" class="ss-nav-link">
                    <i class="fas fa-search"></i>
                    <span>Recherche</span>
                </a>
                <a href="/help" class="ss-nav-link">
                    <i class="fas fa-question-circle"></i>
                    <span>Aide</span>
                </a>
            </div>

            <div class="ss-nav-actions">
                <% if (user) { %>
                    <!-- Cloche desktop avec dropdown hover -->
                    <div class="ss-notif-wrap" id="notifDropdownDesktop">
                        <a href="/notifications" class="ss-notif-btn" id="notifBellDesktop">
                            <i class="fa-solid fa-bell"></i>
                            <span class="notif-badge" id="notifBadgeDesktop" style="display:none;">0</span>
                        </a>
                        <div class="ss-dropdown ss-dropdown--notif" id="notifDropdownPanel">
                            <div class="notif-dropdown-header">
                                <strong>Notifications</strong>
                                <a href="#" id="notifMarkAllDropdown" class="notif-dropdown-mark-all">Tout lire</a>
                            </div>
                            <div id="notifDropdownList" class="notif-dropdown-list">
                                <p class="notif-dropdown-empty">Chargement...</p>
                            </div>
                            <a href="/notifications" class="notif-dropdown-footer">Voir toutes les notifications</a>
                        </div>
                    </div>

                    <!-- Prénom + dropdown desktop -->
                    <div class="ss-user-wrap" id="userDropdownDesktop">
                        <button class="ss-user-btn" id="userDropdownDesktopToggle">
                            <i class="fas fa-user-circle"></i>
                            <span><%= user.firstname %></span>
                            <i class="fas fa-chevron-down ss-chevron"></i>
                        </button>
                        <div class="ss-dropdown ss-dropdown--right">
                            <a href="/user/<%= user.id %>/profil" class="ss-dropdown-item">
                                <i class="fas fa-user ss-di-amber"></i>
                                Mon profil
                            </a>
                            <a href="/messages" class="ss-dropdown-item">
                                <i class="fas fa-envelope ss-di-amber"></i>
                                Messages
                                <span class="message-badge" id="messageBadgeDesktop" style="display:none;">0</span>
                            </a>
                            <hr class="ss-dropdown-sep">
                            <form action="/logout" class="ss-dropdown-item ss-dropdown-item--logout" method="POST">
                                <button type="submit">Déconnexion</button>
                            </form>
                        </div>
                    </div>
                <% } else { %>
                    <a href="/login" class="ss-btn-nav ss-btn-nav--outline">
                        <i class="fas fa-sign-in-alt"></i>
                        Connexion
                    </a>
                    <a href="/register" class="ss-btn-nav ss-btn-nav--filled">
                        <i class="fas fa-user-plus"></i>
                        Inscription
                    </a>
                <% } %>
            </div>
        </div>

    </div>
</nav>

<% if (user) { %>
<script nonce="<%= cspNonce %>">
  window.currentUserId = <%= user.id %>;

  async function loadNotifBadge() {
    try {
      const res = await fetch('/api/notifications/count');
      if (!res.ok) return;
      const data = await res.json();
      document.querySelectorAll('.notif-badge').forEach(badge => {
        if (data.count > 0) {
          badge.textContent = data.count > 99 ? '99+' : data.count;
          badge.style.display = '';
        } else {
          badge.style.display = 'none';
        }
      });
    } catch (e) { /* silently fail */ }
  }

  async function loadMessageBadge() {
    try {
      const res = await fetch('/api/messages/unread-count');
      if (!res.ok) return;
      const data = await res.json();
      document.querySelectorAll('.message-badge').forEach(badge => {
        if (data.count > 0) {
          badge.textContent = data.count > 99 ? '99+' : data.count;
          badge.style.display = '';
        } else {
          badge.style.display = 'none';
        }
      });
    } catch (e) { /* silently fail */ }
  }

  async function loadNotifDropdown() {
    try {
      const res = await fetch('/api/notifications/recent');
      if (!res.ok) return;
      const data = await res.json();
      const list = document.getElementById('notifDropdownList');
      if (!list) return;

      while (list.firstChild) list.removeChild(list.firstChild);

      if (data.notifications.length === 0) {
        const p = document.createElement('p');
        p.className = 'notif-dropdown-empty';
        p.textContent = 'Aucune notification';
        list.appendChild(p);
        return;
      }

      const iconMap = { message: 'fa-envelope', review: 'fa-star', follow: 'fa-user-plus' };

      data.notifications.forEach(n => {
        const a = document.createElement('a');
        a.href = n.action_url || '/notifications';
        a.className = 'notif-dropdown-item' + (n.is_read ? '' : ' notif-dropdown-item-unread');

        const iconWrap = document.createElement('span');
        iconWrap.className = 'ss-di-icon';
        const icon = document.createElement('i');
        icon.className = 'fa-solid ' + (iconMap[n.type_notification] || 'fa-bell');
        iconWrap.appendChild(icon);

        const text = document.createElement('span');
        text.className = 'notif-dropdown-item-text';
        text.textContent = n.content;

        const date = document.createElement('span');
        date.className = 'notif-dropdown-item-date';
        date.textContent = new Date(n.created_at).toLocaleDateString('fr-FR', { day: 'numeric', month: 'short' });

        a.appendChild(iconWrap);
        a.appendChild(text);
        a.appendChild(date);
        list.appendChild(a);
      });
    } catch (e) { /* silently fail */ }
  }

  const notifPanel = document.getElementById('notifDropdownDesktop');
  if (notifPanel) {
    notifPanel.addEventListener('mouseenter', () => {
      notifPanel.classList.add('is-active');
      loadNotifDropdown();
    });
    notifPanel.addEventListener('mouseleave', () => {
      notifPanel.classList.remove('is-active');
    });
    document.addEventListener('click', (e) => {
      if (!notifPanel.contains(e.target)) notifPanel.classList.remove('is-active');
    });
  }

  const markAllDropdown = document.getElementById('notifMarkAllDropdown');
  if (markAllDropdown) {
    markAllDropdown.addEventListener('click', async (e) => {
      e.preventDefault();
      await fetch('/api/notifications/read-all', { method: 'POST' });
      loadNotifBadge();
      loadNotifDropdown();
    });
  }

  loadNotifBadge();
  loadMessageBadge();

  window.refreshNotificationBadge    = loadNotifBadge;
  window.refreshNotificationDropdown = loadNotifDropdown;
  window.refreshMessageBadge         = loadMessageBadge;

  setInterval(loadNotifBadge,   30000);
  setInterval(loadMessageBadge, 30000);
</script>
<% } %>
