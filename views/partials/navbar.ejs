<nav class="navbar">
    <div class="container">
        <div class="navbar-brand">
            <a class="navbar-item has-text-light navbar-logo" href="/">
                <span class="logo-text">SkillSwap</span>
            </a>

            <!-- Avatar compact : mobile/tablet uniquement -->
            <% if (user) { %>
                <!-- Cloche notifications mobile -->
                <div class="navbar-item is-hidden-desktop notif-bell-mobile" id="notifBellMobile">
                    <a href="/notifications" class="notif-bell-link">
                        <span class="icon has-text-light">
                            <i class="fa-solid fa-bell"></i>
                        </span>
                        <span class="notif-badge" id="notifBadgeMobile" style="display:none;">0</span>
                    </a>
                </div>

                <div class="navbar-item has-dropdown is-hidden-desktop" id="userDropdownMobile">
                    <a class="user-avatar-btn" id="userDropdownMobileToggle">
                        <i class="fas fa-user-circle"></i>
                    </a>
                    <div class="navbar-dropdown is-right user-avatar-dropdown">
                        <a class="navbar-item" href="/user/<%= user.id %>/profil">
                            <span class="icon dropdown-icon-profil"><i class="fas fa-user"></i></span>
                            <span>Mon profil</span>
                        </a>
                        <a class="navbar-item" href="/messages">
                            <span class="icon dropdown-icon-messages"><i class="fas fa-envelope"></i></span>
                            <span>Messages</span>
                            <span class="message-badge" id="messageBadgeMobile" style="display:none;">0</span>
                        </a>
                        <a class="navbar-item" href="/notifications">
                            <span class="icon dropdown-icon-messages"><i class="fas fa-bell"></i></span>
                            <span>Notifications</span>
                        </a>
                        <hr class="navbar-divider dropdown-divider">
                        <form action="/logout" method="POST" class="navbar-item dropdown-item-logout" style="display:inline;">
                            <button type="submit">
                                <span class="icon"><i class="fas fa-sign-out-alt"></i></span>
                                <span>Déconnexion</span>
                            </button>
                        </form>
                    </div>
                </div>
            <% } %>

            <a role="button" class="navbar-burger" id="burger">
                <span aria-hidden="true"></span>
                <span aria-hidden="true"></span>
                <span aria-hidden="true"></span>
                <span aria-hidden="true"></span>
            </a>
        </div>

        <div class="navbar-menu" id="navbarMenu">
            <div class="navbar-end">
                <a class="navbar-item has-text-light nav-link" href="/">
                    <span class="icon icon-home"><i class="fas fa-home"></i></span>
                    <span>Accueil</span>
                </a>

                <a class="navbar-item has-text-light nav-link" href="/talents">
                    <span class="icon icon-talents"><i class="fas fa-users"></i></span>
                    <span>Talents</span>
                </a>

                <a class="navbar-item has-text-light nav-link" href="/skills">
                    <span class="icon icon-skills"><i class="fas fa-star"></i></span>
                    <span>Compétences</span>
                </a>

                <a class="navbar-item has-text-light nav-link" href="/search">
                    <span class="icon icon-search"><i class="fas fa-search"></i></span>
                    <span>Recherche</span>
                </a>

                <a class="navbar-item has-text-light nav-link" href="/help">
                    <span class="icon icon-help"><i class="fas fa-question-circle"></i></span>
                    <span>Aide</span>
                </a>

                <!-- Dropdown avec prénom : desktop uniquement -->
                <% if (user) { %>
                    <!-- Cloche notifications desktop avec dropdown -->
                    <div class="navbar-item has-dropdown is-hidden-touch" id="notifDropdownDesktop">
                        <a class="navbar-link is-arrowless notif-bell-link" id="notifBellDesktop" href="/notifications">
                            <span class="icon has-text-light">
                                <i class="fa-solid fa-bell"></i>
                            </span>
                            <span class="notif-badge" id="notifBadgeDesktop" style="display:none;">0</span>
                        </a>
                        <div class="navbar-dropdown is-right notif-dropdown-panel" id="notifDropdownPanel">
                            <div class="notif-dropdown-header">
                                <strong>Notifications</strong>
                                <a href="#" id="notifMarkAllDropdown" class="notif-dropdown-mark-all">Tout lire</a>
                            </div>
                            <div id="notifDropdownList" class="notif-dropdown-list">
                                <p class="notif-dropdown-empty">Chargement...</p>
                            </div>
                            <a href="/notifications" class="notif-dropdown-footer">Voir toutes les notifications</a>
                        </div>
                    </div>

                    <div class="navbar-item has-dropdown is-hidden-touch" id="userDropdownDesktop">
                        <a class="navbar-link is-arrowless" id="userDropdownDesktopToggle">
                            <span class="icon"><i class="fas fa-user-circle"></i></span>
                            <span><%= user.firstname %></span>
                            <span class="icon is-small chevron-icon"><i class="fas fa-chevron-down"></i></span>
                        </a>
                        <div class="navbar-dropdown is-right">
                            <a class="navbar-item" href="/user/<%= user.id %>/profil">
                                <span class="icon dropdown-icon-profil"><i class="fas fa-user"></i></span>
                                <span>Mon profil</span>
                            </a>
                            <a class="navbar-item" href="/messages">
                                <span class="icon dropdown-icon-messages"><i class="fas fa-envelope"></i></span>
                                <span>Messages</span>
                                <span class="message-badge" id="messageBadgeDesktop" style="display:none;">0</span>
                            </a>
                            <hr class="navbar-divider dropdown-divider">
                            <form action="/logout" class="navbar-item dropdown-item-logout" method="POST" style="display:inline;">
                                <button type="submit">Déconnexion</button>
                            </form>
                        </div>
                    </div>
                <% } else { %>
                    <a class="navbar-item btn-login" href="/login">
                        <span class="icon"><i class="fas fa-sign-in-alt"></i></span>
                        <span>Connexion</span>
                    </a>

                    <a class="navbar-item btn-register" href="/register">
                        <span class="icon"><i class="fas fa-user-plus"></i></span>
                        <span>Inscription</span>
                    </a>
                <% } %>
            </div>
        </div>
    </div>
</nav>

<% if (user) { %>
<script nonce="<%= cspNonce %>">
  window.currentUserId = <%= user.id %>;

  // Charger le badge de notifications non lues
  async function loadNotifBadge() {
    try {
      const res = await fetch('/api/notifications/count');
      if (!res.ok) return;
      const data = await res.json();
      const badges = document.querySelectorAll('.notif-badge');
      badges.forEach(badge => {
        if (data.count > 0) {
          badge.textContent = data.count > 99 ? '99+' : data.count;
          badge.style.display = '';
        } else {
          badge.style.display = 'none';
        }
      });
    } catch (e) { /* silently fail */ }
  }

  // Charger le badge des messages non lus
  async function loadMessageBadge() {
    try {
      const res = await fetch('/api/messages/unread-count');
      if (!res.ok) return;
      const data = await res.json();
      const badges = document.querySelectorAll('.message-badge');
      badges.forEach(badge => {
        if (data.count > 0) {
          badge.textContent = data.count > 99 ? '99+' : data.count;
          badge.style.display = '';
        } else {
          badge.style.display = 'none';
        }
      });
    } catch (e) { /* silently fail */ }
  }

  // Charger les notifications récentes dans le dropdown desktop
  async function loadNotifDropdown() {
    try {
      const res = await fetch('/api/notifications/recent');
      if (!res.ok) return;
      const data = await res.json();
      const list = document.getElementById('notifDropdownList');
      if (!list) return;

      if (data.notifications.length === 0) {
        list.innerHTML = '<p class="notif-dropdown-empty">Aucune notification</p>';
        return;
      }

      list.innerHTML = data.notifications.map(n => {
        const iconClass = n.type_notification === 'message' ? 'fa-envelope'
          : n.type_notification === 'review' ? 'fa-star'
          : n.type_notification === 'follow' ? 'fa-user-plus'
          : 'fa-bell';
        const unreadClass = n.is_read ? '' : 'notif-dropdown-item-unread';
        const date = new Date(n.created_at).toLocaleDateString('fr-FR', { day: 'numeric', month: 'short' });
        const link = n.action_url || '/notifications';
        return `<a href="${link}" class="notif-dropdown-item ${unreadClass}">
          <span class="icon is-small"><i class="fa-solid ${iconClass}"></i></span>
          <span class="notif-dropdown-item-text">${n.content}</span>
          <span class="notif-dropdown-item-date">${date}</span>
        </a>`;
      }).join('');
    } catch (e) { /* silently fail */ }
  }

  // Toggle dropdown notifications desktop
  const notifBell = document.getElementById('notifBellDesktop');
  const notifPanel = document.getElementById('notifDropdownDesktop');
  if (notifBell && notifPanel) {
    // Desktop UX:
    // - clic sur la cloche -> page /notifications (comportement mobile)
    // - survol -> dropdown rapide des notifications récentes
    notifPanel.addEventListener('mouseenter', () => {
      notifPanel.classList.add('is-active');
      loadNotifDropdown();
    });

    notifPanel.addEventListener('mouseleave', () => {
      notifPanel.classList.remove('is-active');
    });

    // Fermer le dropdown en cliquant ailleurs
    document.addEventListener('click', (e) => {
      if (!notifPanel.contains(e.target)) {
        notifPanel.classList.remove('is-active');
      }
    });
  }

  // Tout marquer comme lu depuis le dropdown
  const markAllDropdown = document.getElementById('notifMarkAllDropdown');
  if (markAllDropdown) {
    markAllDropdown.addEventListener('click', async (e) => {
      e.preventDefault();
      await fetch('/api/notifications/read-all', { method: 'POST' });
      loadNotifBadge();
      loadNotifDropdown();
    });
  }

  // Charger le badge au chargement de la page
  loadNotifBadge();
  loadMessageBadge();

  // Exposer des helpers globaux utilises par socket.js/chat.js
  window.refreshNotificationBadge = loadNotifBadge;
  window.refreshNotificationDropdown = loadNotifDropdown;
  window.refreshMessageBadge = loadMessageBadge;

  // Rafraîchir le badge toutes les 30 secondes (avant Socket.IO)
  setInterval(loadNotifBadge, 30000);
  setInterval(loadMessageBadge, 30000);
</script>
<% } %>
