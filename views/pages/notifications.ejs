<%- include('../partials/header.ejs') %>
</head>
<%- include('../partials/navbar.ejs') %>

<main class="ss-notif-main">
  <div class="ss-notif-container">

    <!-- Header -->
    <div class="ss-notif-header">
      <div class="ss-notif-title-wrap">
        <h1 class="ss-notif-title">
          <i class="fa-solid fa-bell"></i>
          Notifications
        </h1>
        <p class="ss-notif-subtitle">
          <% if (unreadCount > 0) { %>
            Vous avez <strong style="color:var(--notif-amber)"><%= unreadCount %></strong>
            notification<%= unreadCount > 1 ? 's' : '' %> non lue<%= unreadCount > 1 ? 's' : '' %>
          <% } else { %>
            Toutes vos notifications sont lues
          <% } %>
        </p>
      </div>
      <% if (unreadCount > 0) { %>
        <button class="ss-notif-mark-all" id="markAllReadBtn">
          <i class="fa-solid fa-check-double"></i>
          <span>Tout marquer comme lu</span>
        </button>
      <% } %>
    </div>

    <!-- Contenu -->
    <% if (notifications.length === 0) { %>
      <div class="ss-notif-empty">
        <i class="fa-solid fa-bell-slash ss-notif-empty-icon"></i>
        <h3 class="ss-notif-empty-title">Aucune notification</h3>
        <p class="ss-notif-empty-text">Vous n'avez pas encore reçu de notifications.</p>
      </div>
    <% } else { %>
      <div class="ss-notif-list">
        <% notifications.forEach((notif) => { %>
          <div class="ss-notif-item <%= notif.is_read ? '' : 'ss-notif-item--unread' %>" data-id="<%= notif.id %>">

            <!-- Icône -->
            <div class="ss-notif-icon-box">
              <% if (notif.type_notification === 'message') { %>
                <i class="fa-solid fa-envelope"></i>
              <% } else if (notif.type_notification === 'review') { %>
                <i class="fa-solid fa-star"></i>
              <% } else if (notif.type_notification === 'follow') { %>
                <i class="fa-solid fa-user-plus"></i>
              <% } else { %>
                <i class="fa-solid fa-bell"></i>
              <% } %>
            </div>

            <!-- Contenu -->
            <div class="ss-notif-content">
              <p class="ss-notif-text"><%= notif.content %></p>
              <p class="ss-notif-time">
                <i class="fa-regular fa-clock"></i>
                <%= new Date(notif.created_at).toLocaleDateString('fr-FR', { day: 'numeric', month: 'short', year: 'numeric', hour: '2-digit', minute: '2-digit' }) %>
              </p>
            </div>

            <!-- Actions -->
            <div class="ss-notif-actions">
              <% if (!notif.is_read) { %>
                <button class="ss-notif-read-btn" data-id="<%= notif.id %>" title="Marquer comme lu">
                  <i class="fa-solid fa-check"></i>
                </button>
              <% } %>
              <% if (notif.action_url) { %>
                <a href="<%= notif.action_url %>" class="ss-notif-view-btn" title="Voir">
                  <i class="fa-solid fa-arrow-right"></i>
                </a>
              <% } %>
              <button class="ss-notif-delete-btn" data-id="<%= notif.id %>" title="Supprimer">
                <i class="fa-solid fa-trash"></i>
              </button>
            </div>

          </div>
        <% }) %>
      </div>

      <!-- Pagination -->
      <% if (totalPages > 1) { %>
        <nav class="ss-notif-pagination" aria-label="pagination">
          <% if (currentPage > 1) { %>
            <a class="ss-notif-page-link" href="/notifications?page=<%= currentPage - 1 %>">← Précédent</a>
          <% } else { %>
            <a class="ss-notif-page-link" disabled>← Précédent</a>
          <% } %>

          <% for (let i = 1; i <= totalPages; i++) { %>
            <a class="ss-notif-page-link <%= i === currentPage ? 'ss-notif-page-link--active' : '' %>"
               href="/notifications?page=<%= i %>"><%= i %></a>
          <% } %>

          <% if (currentPage < totalPages) { %>
            <a class="ss-notif-page-link" href="/notifications?page=<%= currentPage + 1 %>">Suivant →</a>
          <% } else { %>
            <a class="ss-notif-page-link" disabled>Suivant →</a>
          <% } %>
        </nav>
      <% } %>
    <% } %>

  </div>
</main>

<script nonce="<%= cspNonce %>">
  document.querySelectorAll('.ss-notif-read-btn').forEach(btn => {
    btn.addEventListener('click', async () => {
      const id = btn.dataset.id;
      const res = await fetch(`/api/notifications/${id}/read`, { method: 'POST' });
      if (res.ok) {
        const item = btn.closest('.ss-notif-item');
        item.classList.remove('ss-notif-item--unread');
        btn.remove();
      }
    });
  });

  document.querySelectorAll('.ss-notif-delete-btn').forEach(btn => {
    btn.addEventListener('click', async () => {
      const id = btn.dataset.id;
      const res = await fetch(`/api/notifications/${id}/delete`, { method: 'POST' });
      if (res.ok) { btn.closest('.ss-notif-item').remove(); }
    });
  });

  const markAllBtn = document.getElementById('markAllReadBtn');
  if (markAllBtn) {
    markAllBtn.addEventListener('click', async () => {
      const res = await fetch('/api/notifications/read-all', { method: 'POST' });
      if (res.ok) {
        document.querySelectorAll('.ss-notif-item--unread').forEach(el => el.classList.remove('ss-notif-item--unread'));
        document.querySelectorAll('.ss-notif-read-btn').forEach(btn => btn.remove());
        markAllBtn.remove();
      }
    });
  }
</script>

<%- include('../partials/footer.ejs') %>

</body>
</html>
