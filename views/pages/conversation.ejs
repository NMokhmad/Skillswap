<%- include('../partials/header.ejs') %>
</head>

<body>
<%- include('../partials/navbar.ejs') %>

<main
    class="ss-conv-main"
    id="conversation-page"
    data-current-user-id="<%= currentUserId %>"
    data-other-user-id="<%= otherUser.id %>"
>
    <div class="ss-conv-container">

        <!-- Header -->
        <div class="ss-conv-header">
            <a href="/messages" class="ss-conv-back">
                <i class="fas fa-arrow-left"></i>
                Retour
            </a>
            <div class="ss-conv-avatar">
                <span class="ss-conv-avatar-initials">
                    <%= otherUser.firstname.charAt(0).toUpperCase() %><%= otherUser.lastname.charAt(0).toUpperCase() %>
                </span>
            </div>
            <a href="/talents/<%= otherUser.id %>" class="ss-conv-user-link">
                <%= otherUser.firstname %> <%= otherUser.lastname %>
            </a>
        </div>

        <!-- Messages -->
        <div class="ss-conv-messages-box" id="messages-container">
            <% if (messages.length === 0) { %>
                <p class="ss-conv-empty">
                    Aucun message. Commencez la conversation !
                </p>
            <% } %>

            <% messages.forEach(msg => { %>
                <% const isMine = msg.sender_id === currentUserId; %>
                <div class="ss-conv-message-row <%= isMine ? 'ss-conv-message-row--mine' : 'ss-conv-message-row--theirs' %>" data-message-id="<%= msg.id %>">
                    <div class="ss-conv-bubble <%= isMine ? 'ss-conv-bubble--mine' : 'ss-conv-bubble--theirs' %>">
                        <p class="ss-conv-bubble-text"><%= msg.content %></p>
                        <p class="ss-conv-bubble-time">
                            <%= new Date(msg.created_at).toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' }) %>
                        </p>
                    </div>
                </div>
            <% }) %>
        </div>

        <div id="typing-indicator" class="ss-conv-typing" hidden>
            <i class="fas fa-pen"></i>
            <span><%= otherUser.firstname %> est en train d'écrire...</span>
        </div>

        <!-- Formulaire d'envoi -->
        <div class="ss-conv-send-box">
            <form action="/messages/<%= otherUser.id %>" method="POST" id="message-form" class="ss-conv-send-form">
                <input
                    class="ss-conv-input"
                    id="message-input"
                    type="text"
                    name="content"
                    placeholder="Écrire un message..."
                    required
                    autocomplete="off"
                >
                <button type="submit" class="ss-conv-send-btn" id="message-submit">
                    <i class="fas fa-paper-plane"></i>
                </button>
            </form>
        </div>

    </div>
</main>

<script nonce="<%= cspNonce %>">
    const container = document.getElementById('messages-container');
    if (container) {
        container.scrollTop = container.scrollHeight;
    }
</script>
<script src="/js/chat.js" defer></script>

<%- include('../partials/footer.ejs') %>
</body>
</html>
