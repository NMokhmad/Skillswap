<%- include('../partials/header.ejs') %>
</head>

<body>
    <%- include('../partials/navbar.ejs') %>

    <div class="ss-ob-page">
        <div class="ss-ob-card">

            <!-- En-tête -->
            <div class="ss-ob-header">
                <h1 class="ss-ob-title">Bienvenue, <em><%= user.firstname %></em> !</h1>
                <p class="ss-ob-subtitle">Complétez votre profil pour commencer à échanger vos compétences</p>
            </div>

            <form id="ob-form" action="/onboarding" method="POST" enctype="multipart/form-data">

                <!-- Section 1 : Avatar -->
                <div class="ss-ob-section">
                    <div class="ss-ob-section-header">
                        <h2 class="ss-ob-section-title">
                            <i class="fas fa-camera"></i>
                            Photo de profil
                        </h2>
                        <span class="ss-ob-badge ss-ob-badge--optional">Optionnel</span>
                    </div>
                    <div class="ss-ob-avatar-wrap">
                        <label class="ss-ob-avatar-zone" for="avatar" aria-label="Choisir une photo de profil">
                            <i class="fas fa-camera ss-ob-avatar-icon" id="avatarIcon"></i>
                            <img class="ss-ob-avatar-img" id="avatarPreview" src="" alt="Aperçu avatar">
                            <input type="file" name="avatar" id="avatar" accept="image/*" style="display:none;">
                        </label>
                        <p class="ss-ob-avatar-hint">JPG, PNG, GIF · max 5 Mo</p>
                        <span class="ss-ob-avatar-filename" id="avatarFilename" style="display:none;"></span>
                    </div>
                </div>

                <hr class="ss-ob-sep">

                <!-- Section 2 : Bio -->
                <div class="ss-ob-section">
                    <div class="ss-ob-section-header">
                        <h2 class="ss-ob-section-title">
                            <i class="fas fa-pen-fancy"></i>
                            À propos de vous
                        </h2>
                        <span class="ss-ob-badge ss-ob-badge--optional">Optionnel</span>
                    </div>
                    <div class="ss-ob-textarea-wrap">
                        <textarea
                            class="ss-ob-textarea"
                            name="bio"
                            id="bio"
                            maxlength="500"
                            placeholder="Ex : Passionné de développement web, j'aime partager mes connaissances..."
                        ></textarea>
                        <span class="ss-ob-bio-count" id="bioCount">0/500</span>
                    </div>
                </div>

                <hr class="ss-ob-sep">

                <!-- Section 3 : Compétences -->
                <div class="ss-ob-section">
                    <div class="ss-ob-section-header">
                        <h2 class="ss-ob-section-title">
                            <i class="fas fa-star"></i>
                            Vos compétences
                        </h2>
                        <span class="ss-ob-badge ss-ob-badge--required">Requis</span>
                    </div>

                    <div class="ss-ob-search-wrap">
                        <i class="fas fa-search"></i>
                        <input
                            class="ss-ob-search"
                            type="text"
                            id="skillSearch"
                            placeholder="Rechercher une compétence..."
                            autocomplete="off"
                        >
                    </div>

                    <div class="ss-ob-skills-grid" id="skillsGrid">
                        <% if (skills && skills.length > 0) { %>
                            <% skills.forEach(skill => { %>
                                <label class="ss-ob-pill" data-name="<%= skill.label.toLowerCase() %>">
                                    <input type="checkbox" name="skills[]" value="<%= skill.id %>">
                                    <%= skill.label %>
                                    <i class="fas fa-check ss-ob-pill-check"></i>
                                </label>
                            <% }) %>
                        <% } else { %>
                            <p style="color: rgba(247,242,232,0.38); font-size: 0.82rem;">Aucune compétence disponible.</p>
                        <% } %>
                    </div>

                    <p class="ss-ob-skill-count" id="skillCount"></p>
                </div>

                <hr class="ss-ob-sep">

                <!-- Section 4 : Nouvelle compétence -->
                <div class="ss-ob-section">
                    <div class="ss-ob-section-header">
                        <h2 class="ss-ob-section-title">
                            <i class="fas fa-plus-circle"></i>
                            Proposer une compétence
                        </h2>
                        <span class="ss-ob-badge ss-ob-badge--optional">Optionnel</span>
                    </div>
                    <div class="ss-ob-input-wrap">
                        <input
                            class="ss-ob-input"
                            type="text"
                            name="new_skill"
                            id="newSkill"
                            placeholder="Ex : Photographie culinaire, Arduino, Origami..."
                            maxlength="50"
                        >
                        <i class="fas fa-lightbulb"></i>
                    </div>
                    <p class="ss-ob-input-hint">Cette compétence sera soumise pour validation avant d'être ajoutée au catalogue.</p>
                </div>

                <!-- Actions -->
                <div class="ss-ob-actions">
                    <button type="submit" id="obSubmit" class="ss-ob-btn" disabled>
                        <i class="fas fa-check-circle"></i>
                        Terminer et explorer SkillSwap
                    </button>
                    <a href="/skills" class="ss-ob-skip">
                        <i class="fas fa-clock"></i>
                        Plus tard
                    </a>
                </div>

            </form>

        </div><!-- /.ss-ob-card -->
    </div><!-- /.ss-ob-page -->

    <!-- JS inline : avatar preview + bio counter + skills filter + submit guard -->
    <script nonce="<%= cspNonce %>">
    (function () {

        /* ── Avatar ── */
        const avatarInput    = document.getElementById('avatar');
        const avatarPreview  = document.getElementById('avatarPreview');
        const avatarIcon     = document.getElementById('avatarIcon');
        const avatarFilename = document.getElementById('avatarFilename');

        if (avatarInput) {
            avatarInput.addEventListener('change', function () {
                const file = this.files[0];
                if (!file) return;

                avatarFilename.textContent = file.name;
                avatarFilename.style.display = 'block';

                const reader = new FileReader();
                reader.onload = function (e) {
                    avatarPreview.src = e.target.result;
                    avatarPreview.style.display = 'block';
                    avatarIcon.style.display = 'none';
                };
                reader.readAsDataURL(file);
            });
        }

        /* ── Bio counter ── */
        const bioTextarea = document.getElementById('bio');
        const bioCount    = document.getElementById('bioCount');

        if (bioTextarea && bioCount) {
            bioTextarea.addEventListener('input', function () {
                bioCount.textContent = this.value.length + '/500';
            });
        }

        /* ── Skills : filter + counter + submit guard ── */
        const skillSearch = document.getElementById('skillSearch');
        const submitBtn   = document.getElementById('obSubmit');
        const skillCount  = document.getElementById('skillCount');
        const pills       = document.querySelectorAll('.ss-ob-pill');

        function updateSkillCount() {
            const checked = document.querySelectorAll('.ss-ob-pill input:checked').length;
            if (checked > 0) {
                skillCount.textContent = checked + ' compétence' + (checked > 1 ? 's' : '') + ' sélectionnée' + (checked > 1 ? 's' : '');
                skillCount.style.display = 'block';
                submitBtn.disabled = false;
            } else {
                skillCount.style.display = 'none';
                submitBtn.disabled = true;
            }
        }

        pills.forEach(function (pill) {
            pill.addEventListener('change', updateSkillCount);
        });

        if (skillSearch) {
            skillSearch.addEventListener('input', function () {
                const term = this.value.toLowerCase();
                pills.forEach(function (pill) {
                    const name = pill.getAttribute('data-name') || '';
                    pill.style.display = name.includes(term) ? '' : 'none';
                });
            });
        }

        /* ── Submit guard ── */
        const form = document.getElementById('ob-form');
        if (form) {
            form.addEventListener('submit', function (e) {
                const checked = document.querySelectorAll('.ss-ob-pill input:checked').length;
                if (checked === 0) {
                    e.preventDefault();
                    skillCount.textContent = 'Veuillez sélectionner au moins une compétence.';
                    skillCount.style.display = 'block';
                    skillCount.style.color = 'rgba(220, 80, 80, 0.85)';
                }
            });
        }

    })();
    </script>

    <%- include('../partials/footer.ejs') %>
</body>
</html>
