<%- include('../partials/header.ejs') %>
</head>

<body>
<%- include('../partials/navbar.ejs') %>

<main class="ss-tp-main">
  <div class="ss-tp-container">
    <div class="ss-tp-grid">

      <!-- Colonne principale -->
      <div>

        <!-- Header profil -->
        <div class="ss-tp-card ss-tp-header">
          <div class="ss-tp-verified">
            <i class="fa-solid fa-circle-check"></i>
            <span>Vérifié</span>
          </div>

          <div class="ss-tp-avatar">
            <%= profils.firstname.charAt(0).toUpperCase() %><%= profils.lastname.charAt(0).toUpperCase() %>
          </div>

          <h1 class="ss-tp-name"><%= profils.firstname %> <%= profils.lastname %></h1>

          <div class="ss-tp-stars-row">
            <% const fullStars = Math.floor(averageRating); %>
            <% const hasHalf = averageRating % 1 >= 0.5; %>
            <% for (let i = 0; i < fullStars; i++) { %><i class="fa-solid fa-star filled"></i><% } %>
            <% if (hasHalf) { %><i class="fa-solid fa-star-half-stroke filled"></i><% } %>
            <% for (let i = fullStars + (hasHalf ? 1 : 0); i < 5; i++) { %><i class="fa-regular fa-star"></i><% } %>
          </div>
          <span class="ss-tp-rating"><%= averageRating.toFixed(1) %>/5 · <%= reviewCount %> avis</span>

          <div class="ss-tp-actions">
            <button
              class="ss-tp-btn-follow btn-follow <%= isFollowing ? 'is-following' : '' %>"
              data-user-id="<%= profils.id %>"
              data-following="<%= isFollowing ? 'true' : 'false' %>"
            >
              <i class="fa-solid <%= isFollowing ? 'fa-user-minus' : 'fa-user-plus' %>"></i>
              <span><%= isFollowing ? 'Ne plus suivre' : 'Suivre' %></span>
            </button>
            <a href="/messages/<%= profils.id %>" class="ss-tp-btn-message">
              <i class="fa-solid fa-paper-plane"></i>
              <span>Message</span>
            </a>
          </div>
        </div>

        <% if (profils.bio) { %>
        <!-- Bio -->
        <div class="ss-tp-card">
          <h2 class="ss-tp-section-title"><i class="fa-solid fa-user"></i> À propos</h2>
          <hr class="ss-tp-divider">
          <p class="ss-tp-bio"><%= profils.bio %></p>
        </div>
        <% } %>

        <!-- Compétences -->
        <div class="ss-tp-card">
          <h2 class="ss-tp-section-title"><i class="fa-solid fa-certificate"></i> Compétences</h2>
          <hr class="ss-tp-divider">
          <div class="ss-tp-skills">
            <% profils.skills.forEach(skill => { %>
              <a href="/skills/<%= skill.slug %>" class="ss-tp-pill"><%= skill.label %></a>
            <% }) %>
          </div>
        </div>

        <!-- Contact -->
        <div class="ss-tp-card">
          <h2 class="ss-tp-section-title"><i class="fa-solid fa-envelope"></i> Contact</h2>
          <hr class="ss-tp-divider">
          <div class="ss-tp-contact">
            <i class="fa-solid fa-at"></i>
            <span><%= profils.email %></span>
          </div>
        </div>

        <!-- Avis -->
        <div class="ss-tp-card">
          <div class="ss-tp-reviews-header">
            <h2 class="ss-tp-section-title" style="margin:0">
              <i class="fa-solid fa-comments"></i> Avis des utilisateurs
            </h2>
            <% if (typeof user !== 'undefined' && user && user.id !== profils.id) { %>
              <button class="ss-tp-btn-add-review" id="btn-toggle-review-form">
                <i class="fa-solid fa-plus"></i>
                <span>Laisser un avis</span>
              </button>
            <% } %>
          </div>

          <% if (typeof user !== 'undefined' && user && user.id !== profils.id) { %>
          <div id="review-form-container" style="display:none;" class="ss-tp-review-form">
            <div class="ss-tp-card">
              <form action="/review/<%= profils.id %>" method="POST">
                <div class="ss-tp-field">
                  <label class="ss-tp-form-label">Note</label>
                  <input type="hidden" name="rate" id="review-rate" value="0">
                  <div class="ss-tp-review-stars">
                    <% for (let i = 1; i <= 5; i++) { %>
                      <span class="ss-tp-review-star" data-value="<%= i %>">
                        <i class="far fa-star"></i>
                      </span>
                    <% } %>
                  </div>
                </div>
                <div class="ss-tp-field">
                  <label class="ss-tp-form-label">Compétence évaluée</label>
                  <select name="skill_id" required class="ss-tp-select">
                    <option value="">-- Choisir une compétence --</option>
                    <% profils.skills.forEach(skill => { %>
                      <option value="<%= skill.id %>"><%= skill.label %></option>
                    <% }) %>
                  </select>
                </div>
                <div class="ss-tp-field">
                  <label class="ss-tp-form-label">Commentaire</label>
                  <textarea name="content" class="ss-tp-textarea" placeholder="Décrivez votre expérience..." rows="3"></textarea>
                </div>
                <button type="submit" class="ss-tp-btn-submit">
                  <i class="fa-solid fa-paper-plane"></i>
                  Envoyer mon avis
                </button>
              </form>
            </div>
          </div>
          <% } %>

          <!-- Liste avis -->
          <% if (reviews.length === 0) { %>
            <p class="ss-tp-no-reviews">Aucun avis pour le moment.</p>
          <% } %>

          <% reviews.forEach((review) => { %>
            <div class="ss-tp-review-card">
              <div class="ss-tp-review-meta">
                <div class="ss-tp-reviewer">
                  <div class="ss-tp-reviewer-avatar">
                    <%= review.reviewer.firstname.charAt(0).toUpperCase() %><%= review.reviewer.lastname.charAt(0).toUpperCase() %>
                  </div>
                  <div>
                    <a href="/talents/<%= review.reviewer.id %>" class="ss-tp-reviewer-name">
                      <%= review.reviewer.firstname %> <%= review.reviewer.lastname %>
                    </a>
                    <p class="ss-tp-review-date">
                      <%= new Date(review.created_at).toLocaleDateString('fr-FR', { day: 'numeric', month: 'long', year: 'numeric' }) %>
                    </p>
                  </div>
                </div>
                <div class="ss-tp-review-stars-display">
                  <% for (let i = 0; i < review.rate; i++) { %><i class="fa-solid fa-star filled"></i><% } %>
                  <% for (let i = review.rate; i < 5; i++) { %><i class="fa-regular fa-star"></i><% } %>
                </div>
              </div>
              <% if (review.content) { %>
                <p class="ss-tp-review-content"><%= review.content %></p>
              <% } %>
            </div>
          <% }) %>

        </div><!-- /.ss-tp-card avis -->

      </div><!-- /colonne principale -->

      <!-- Sidebar -->
      <div class="ss-tp-sidebar">
        <div class="ss-tp-card">
          <h3 class="ss-tp-sidebar-title">
            <i class="fa-solid fa-chart-line"></i> Statistiques
          </h3>
          <div class="ss-tp-stat-box">
            <span class="ss-tp-stat-label"><i class="fa-solid fa-certificate"></i> Compétences</span>
            <span class="ss-tp-stat-value"><%= profils.skills.length %></span>
          </div>
          <div class="ss-tp-stat-box">
            <span class="ss-tp-stat-label"><i class="fa-solid fa-comments"></i> Avis reçus</span>
            <span class="ss-tp-stat-value"><%= reviewCount %></span>
          </div>
          <div class="ss-tp-stat-box">
            <span class="ss-tp-stat-label"><i class="fa-solid fa-users"></i> Abonnés</span>
            <span class="ss-tp-stat-value"><%= followerCount %></span>
          </div>
        </div>

        <div class="ss-tp-card ss-tp-member-badge">
          <i class="fa-solid fa-award ss-tp-member-icon"></i>
          <p class="ss-tp-member-label">Membre Vérifié</p>
          <p class="ss-tp-member-date">
            <i class="fa-solid fa-calendar-check"></i>
            Membre depuis <%= new Date(profils.created_at).toLocaleDateString('fr-FR', { month: 'long', year: 'numeric' }) %>
          </p>
        </div>
      </div><!-- /sidebar -->

    </div><!-- /.ss-tp-grid -->
  </div>
</main>

<script src="/js/follow.js"></script>
<script src="/js/review.js"></script>
<script nonce="<%= cspNonce %>">
  const toggleBtn = document.getElementById('btn-toggle-review-form');
  const formContainer = document.getElementById('review-form-container');
  if (toggleBtn && formContainer) {
    toggleBtn.addEventListener('click', () => {
      formContainer.style.display = formContainer.style.display === 'none' ? 'block' : 'none';
    });
  }
</script>

<%- include('../partials/footer.ejs') %>
</body>
</html>
